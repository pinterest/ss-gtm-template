___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "ss_pntr",
  "version": 1,
  "securityGroups": [],
  "displayName": "Pinterest API for Conversions Tag",
  "categories": [
    "CONVERSIONS",
    "TAG_MANAGEMENT"
  ],
  "brand": {
    "thumbnail": "data:image/png;base64,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\u003d",
    "displayName": "Pinterest",
    "id": "brand_pinterest"
  },
  "description": "A server-side Tag to fire events to the Pinterest API for Conversions.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "advertiserId",
    "displayName": "Advertiser ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "args": [
          "549\\d{9}"
        ],
        "type": "REGEX"
      }
    ],
    "help": "Pinterest Advertiser ID. You can find it by logging to the Pinterest account that owns your advertiser account, then go to \"ads.pinterest.com\". In the top navigation section, click on \"Viewing: \" and the advertiser id will be the number underneath the ad account name in the drop down menu. Advertiser Id usually starts with 549..."
  },
  {
    "type": "TEXT",
    "name": "apiAccessToken",
    "displayName": "API Access Token",
    "simpleValueType": true,
    "help": "To use the Pinterest Conversions API, you need an access token.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "eventName",
    "radioItems": [
      {
        "value": "inherit",
        "subParams": [],
        "displayValue": "Inherit from client"
      },
      {
        "value": "pinterestEventName",
        "displayValue": "Override client",
        "subParams": [
          {
            "type": "SELECT",
            "name": "eventNameStandard",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "add_to_cart",
                "displayValue": "add_to_cart"
              },
              {
                "value": "checkout",
                "displayValue": "checkout"
              },
              {
                "value": "custom",
                "displayValue": "custom"
              },
              {
                "value": "lead",
                "displayValue": "lead"
              },
              {
                "value": "page_visit",
                "displayValue": "page_visit"
              },
              {
                "value": "search",
                "displayValue": "search"
              },
              {
                "value": "signup",
                "displayValue": "signup"
              },
              {
                "value": "view_category",
                "displayValue": "view_category"
              },
              {
                "value": "watch_video",
                "displayValue": "watch_video"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "page_visit"
          }
        ]
      }
    ],
    "simpleValueType": true,
    "displayName": "Event Name",
    "defaultValue": "inherit",
    "help": "Set the event name you want to send to Pinterest Conversions API. You can either inherit it from what you defined in Web container (client) or define a new Pinterest standard event name."
  },
  {
    "type": "CHECKBOX",
    "name": "overrideMode",
    "displayName": "Event Data",
    "checkboxText": "Override client data",
    "simpleValueType": true,
    "help": "If checked, you could override or set new values for parameters received from the Web container (client)."
  },
  {
    "displayName": "Event Data",
    "name": "serverEventDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "overrideMode",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "subParams": [
      {
        "name": "serverEventDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "action_source",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "action_source",
                "displayValue": "Action Source"
              },
              {
                "value": "event_time",
                "displayValue": "Event Time"
              },
              {
                "value": "event_id",
                "displayValue": "Event ID"
              },
              {
                "value": "event_source_url",
                "displayValue": "Event Source URL"
              },
              {
                "value": "opt_out",
                "displayValue": "Opt Out"
              },
              {
                "value": "partner_name",
                "displayValue": "Partner Name"
              },
              {
                "value": "app_id",
                "displayValue": "App ID"
              },
              {
                "value": "app_name",
                "displayValue": "App name"
              },
              {
                "value": "app_version",
                "displayValue": "App version"
              },
              {
                "value": "device_brand",
                "displayValue": "Device brand"
              },
              {
                "value": "device_carrier",
                "displayValue": "Device carrier"
              },
              {
                "value": "device_model",
                "displayValue": "Device model"
              },
              {
                "value": "device_type",
                "displayValue": "Device type"
              },
              {
                "value": "os_version",
                "displayValue": "OS version"
              },
              {
                "value": "wifi",
                "displayValue": "WiFi"
              },
              {
                "value": "language",
                "displayValue": "Language"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "displayName": "User Data",
    "name": "userDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "overrideMode",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "subParams": [
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "em",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "em",
                "displayValue": "Email"
              },
              {
                "value": "ph",
                "displayValue": "Phone"
              },
              {
                "value": "ge",
                "displayValue": "Gender"
              },
              {
                "value": "db",
                "displayValue": "Date of Birth"
              },
              {
                "value": "ln",
                "displayValue": "Last Name"
              },
              {
                "value": "fn",
                "displayValue": "First Name"
              },
              {
                "value": "ct",
                "displayValue": "City"
              },
              {
                "value": "st",
                "displayValue": "State"
              },
              {
                "value": "zp",
                "displayValue": "Zip"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "hashed_maids",
                "displayValue": "Maids"
              },
              {
                "value": "client_ip_address",
                "displayValue": "Client IP address"
              },
              {
                "value": "client_user_agent",
                "displayValue": "Client user agent"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "displayName": "Custom Data",
    "name": "customDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "overrideMode",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "subParams": [
      {
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "currency",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "currency",
                "displayValue": "Currency"
              },
              {
                "value": "value",
                "displayValue": "Value"
              },
              {
                "value": "content_ids",
                "displayValue": "Content IDs"
              },
              {
                "value": "contents",
                "displayValue": "Contents"
              },
              {
                "value": "num_items",
                "displayValue": "Number of Items"
              },
              {
                "value": "order_id",
                "displayValue": "Order ID"
              },
              {
                "value": "search_string",
                "displayValue": "Search string"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "testMode",
    "displayName": "Test Mode",
    "checkboxText": "Send as a test-request",
    "simpleValueType": true,
    "help": "If checked, the event will not be recorded but the API will still return the same response messages. Use this mode to verify your requests are working and your events are constructed correctly."
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logMode",
        "radioItems": [
          {
            "value": "log",
            "displayValue": "Log to console"
          },
          {
            "value": "donotlog",
            "displayValue": "Do not log"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "donotlog"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Sandbox Javascript imports
const getAllEventData = require('getAllEventData');
const getType = require('getType');
const sendHttpRequest = require('sendHttpRequest');
const JSON = require('JSON');
const Math = require('Math');
const getTimestampMillis = require('getTimestampMillis');
const sha256Sync = require('sha256Sync');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const parseUrl = require('parseUrl');
const makeInteger = require('makeInteger');
const logToConsole = require('logToConsole');


// CONSTANTS
const isLogEnabled = isLoggingEnabled();
const eventModel = getAllEventData();
if (isLogEnabled) logToConsole(JSON.stringify({'Tag Data': data}));
if (isLogEnabled) logToConsole(JSON.stringify({'Event Data': eventModel}));

// GA4 event names/types: https://support.google.com/analytics/answer/9267735
// Pinterest event names/types: https://developers.pinterest.com/docs/api/v5/#operation/events/create
const EVENT_NAME_MAPPINGS = {
  "add_to_cart": "add_to_cart",
  "addtocart": "add_to_cart",
  "purchase": "checkout",
  "buy": "checkout",
  "pay": "checkout",
  "payment": "checkout",
  "generate_lead": "lead",
  "submit_application": "lead",
  "contact": "lead",
  "page_view": "page_visit",
  "pageview": "page_visit",
  "pagevisit": "page_visit",
  "gtm.dom": "page_visit",
  "search": "search",
  "find_location": "search",
  "sign_up": "signup",
  "signup": "signup",
  "completeregistration": "signup",
  "viewcategory": "view_category",
  "viewcontent": "view_category",
  "view_item_list": "view_category",
  "watchvideo": "watch_video",
  "add_payment_info": "custom",
  "add_shipping_info": "custom",
  "add_to_wishlist": "custom",
  "begin_checkout": "custom",
  "refund": "custom",
  "remove_from_cart": "custom",
  "select_item": "custom",
  "select_promotion": "custom",
  "view_cart": "custom",
  "view_item": "custom",
  "view_promotion": "custom"
};

const PARAM_VALUE_FORMAT = {
  "event_time": "integer",
  "num_items": "integer",
  "opt_out": "boolean",
  "wifi": "boolean",
  "em": "array-hashed",
  "ph": "array-hashed",
  "ge": "array-hashed",
  "db": "array-hashed",
  "fn": "array-hashed",
  "ln": "array-hashed",
  "ct": "array-hashed",
  "st": "array-hashed",
  "zp": "array-hashed",
  "country": "array-hashed",
  "hashed_maids": "array-hashed",
  "external_id": "array-hashed",
  "content_ids": "array"
};

const DEFAULT_NAMED_PARTNER = 'ss-gtm';

const DEFAULT_ACTION_SOURCE = 'web';

const DEFAULT_EVENT_TIME = Math.round(getTimestampMillis() / 1000);

const DEFAULT_CLIENT_IP_ADDRESS = eventModel.ip_override;

const DEFAULT_CLIENT_USER_AGENT = eventModel.user_agent;

// FUNCTIONS
function isAlreadyHashed(input) {
  return input && (input.match('^[A-Fa-f0-9]{64}$') != null);
}

function hashFunction(input) {
  const type = getType(input);

  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  if (input == null || isAlreadyHashed(input)) {
    return input;
  }

  return sha256Sync(input.trim().toLowerCase(), {outputEncoding: 'hex'});
}

function getContentFromItems(items) {
    return items.map(item => {
        return {
            "item_price": item.price,
            "quantity": makeInteger(item.quantity),
        };
    });
}

function getPinterestEventName(gtmEventName, toLowerCase) {
  let pinterestEventName;
  if (data.eventName === 'inherit') {
    if (toLowerCase) {
      gtmEventName = gtmEventName.trim().toLowerCase();
    }
    pinterestEventName = EVENT_NAME_MAPPINGS[gtmEventName] || gtmEventName;
  } else if ( data.eventName === 'pinterestEventName') {
    pinterestEventName = data.eventNameStandard;
  }
  return pinterestEventName;
}

function convertToArrayOfStrings(input, hashIfNeeded) {
  const type = getType(input);
  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  if (input == null) {
    return input;
  }

  let value = (input.charAt(0) === '[' && input.charAt(input.length - 1) === ']' &&
               input.charAt(1) === '\"' && input.charAt(input.length - 2) === '\"') ? JSON.parse(input) : input.toString().replace('[','').replace(']','').split(',');

  return value.map(item => {
    if (hashIfNeeded === true) {
      return hashFunction(item);
    }
    return item;
  });
}

function getBooleanFromString(input) {
  const type = getType(input);
  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  if (input == null) {
    return input;
  }

  return (typeof input === 'string' && (input.toLowerCase() === "true" || input.toLowerCase() === "false")) ? JSON.parse(input.toLowerCase()) : input;
}

function overrideEventData(event, data) {
  if (data.serverEventDataList) {
    data.serverEventDataList.forEach(d => {
      event[d.name] = d.value;
    });
  }
  if (data.userDataList) {
    data.userDataList.forEach(d => {
      event.user_data[d.name] = d.value;
    });
  }
  if (data.customDataList) {
    data.customDataList.forEach(d => {
      event.custom_data[d.name] = d.value;
    });
  }
}

function formatDataTypes(object) {
  for (let key in object) {
    if (object.hasOwnProperty(key)) {
        if (PARAM_VALUE_FORMAT[key] === 'integer') object[key] = makeInteger(object[key]);
        if (PARAM_VALUE_FORMAT[key] === 'boolean') object[key] = getBooleanFromString(object[key]);
        if (PARAM_VALUE_FORMAT[key] === 'array') object[key] = convertToArrayOfStrings(object[key], false);
        if (PARAM_VALUE_FORMAT[key] === 'array-hashed') object[key] = convertToArrayOfStrings(object[key], true);
    }
  }
}

function isLoggingEnabled() {
  return (data.logMode === 'log') ? true : false;
}

// EVENT PARAMETERS
const event = {};
// event_name
event.event_name = getPinterestEventName(eventModel.event_name, true);
// action_source
event.action_source = eventModel.action_source ? eventModel.action_source : DEFAULT_ACTION_SOURCE;
// event_time
event.event_time = eventModel.event_time ? eventModel.event_time : DEFAULT_EVENT_TIME;
// event_id
if (eventModel.event_id) {
  event.event_id = eventModel.event_id.toString();
}
// event_source_url
event.event_source_url = eventModel.event_source_url ? eventModel.event_source_url : eventModel.page_location;
// opt_out
if (eventModel.opt_out) {
  event.opt_out = eventModel.opt_out;
}
// partner_name
if (eventModel.partner_name) {
  event.partner_name = eventModel.partner_name;
}

// AUTHORIZATION PARAMETERS
const apiAccessToken = data.apiAccessToken;

// USER PARAMETERS (user_data)
event.user_data = {};
if (eventModel.user_data != null) {
  // em
  if (eventModel.user_data.email_address) {
    event.user_data.em = eventModel.user_data.email_address;
  }
  // ph
  if (eventModel.user_data.phone_number) {
    event.user_data.ph = eventModel.user_data.phone_number;
  }
  // ge
  if (eventModel.user_data.gender) {
    event.user_data.ge = eventModel.user_data.gender;
  }
  // db
  if (eventModel.user_data.date_of_birth) {
    event.user_data.db = eventModel.user_data.date_of_birth;
  }

  if (eventModel.user_data.address != null) {
    const addressData = eventModel.user_data.address;
    // fn
    event.user_data.fn = addressData.first_name;
    // ln
    event.user_data.ln = addressData.last_name;
    // ct
    event.user_data.ct = addressData.city;
    // st
    event.user_data.st = addressData.region;
    // zp
    event.user_data.zp = addressData.postal_code;
    // country
    event.user_data.country = addressData.country;
  }
  // hashed_maids
  if (eventModel.user_data.hashed_maids) {
    event.user_data.hashed_maids = eventModel.user_data.hashed_maids;
  }
  // external_id
  if (eventModel.user_data.external_id) {
    event.user_data.external_id = eventModel.user_data.external_id;
  }
}

// client_ip_address / default
event.user_data.client_ip_address = (eventModel.user_data && eventModel.user_data.client_ip_address) ? eventModel.user_data.client_ip_address : DEFAULT_CLIENT_IP_ADDRESS;
// client_user_agent / default
event.user_data.client_user_agent = (eventModel.user_data && eventModel.user_data.client_user_agent) ? eventModel.user_data.client_user_agent : DEFAULT_CLIENT_USER_AGENT;

// CUSTOM PARAMETERS (custom_data)
event.custom_data = {};
// currency
if (eventModel.currency) {
  event.custom_data.currency = eventModel.currency;
}
// value
if (eventModel.value) {
  event.custom_data.value = eventModel.value;
}
// content_ids
if (eventModel.content_ids) {
  var content_ids_value = eventModel.content_ids;
  event.custom_data.content_ids = content_ids_value;
}
// contents
if (eventModel.contents) {
  var contents_value = eventModel.contents;
  event.custom_data.contents = JSON.parse(contents_value);
} else if (eventModel.items) {
  event.custom_data.contents = getContentFromItems(eventModel.items);
}
// num_items
if (eventModel.num_items) {
  event.custom_data.num_items = eventModel.num_items;
}
// order_id
if (eventModel.order_id) {
  event.custom_data.order_id = eventModel.order_id;
}
// search_string
if (eventModel.search_string) {
  event.custom_data.search_string = eventModel.search_string;
}
// app_id
if (eventModel.app_id) {
  event.app_id = eventModel.app_id;
}
// app_name
if (eventModel.app_name) {
  event.app_name = eventModel.app_name;
}
// app_version
if (eventModel.app_version) {
  event.app_version = eventModel.app_version;
}
// device_brand
if (eventModel.device_brand) {
  event.device_brand = eventModel.device_brand;
}
// device_carrier
if (eventModel.device_carrier) {
  event.device_carrier = eventModel.device_carrier;
}
// device_model
if (eventModel.device_model) {
  event.device_model = eventModel.device_model;
}
// device_type
if (eventModel.device_type) {
  event.device_type = eventModel.device_type;
}
// os_version
if (eventModel.os_version) {
  event.os_version = eventModel.os_version;
}
// wifi
if (eventModel.wifi) {
  event.wifi = eventModel.wifi;
}
// language
if (eventModel.language) {
  event.language = eventModel.language.slice(0,2);
}

// np
event.custom_data.np = DEFAULT_NAMED_PARTNER;

// OVERRIDE EVENT DATA
if (data.overrideMode) {
  overrideEventData(event, data);
}

// ENSURE CORRECT FORMAT
formatDataTypes(event);
if (event.user_data) formatDataTypes(event.user_data);
if (event.custom_data) formatDataTypes(event.custom_data);

// PINTEREST API ENDPOINT
const API_ENDPOINT = 'https://api.pinterest.com/v5/ad_accounts/';
var requestEndpoint = [API_ENDPOINT, data.advertiserId, '/events'].join('');
if (data.testMode) {
  requestEndpoint = [requestEndpoint,'?test=true'].join('');
}
const eventRequest = {data: [event]};
if (isLogEnabled) {
  logToConsole(JSON.stringify({
    'Name': 'Pinterest Conversions API',
    'Type': 'Request',
    'RequestMethod': 'POST',
    'RequestUrl': requestEndpoint,
    'AdvertiserId': data.advertiserId,
    'EventName': event.event_name,
    'RequestBody (payload)': eventRequest
  }));
}

// Posting to Pinterest Conversions API endpoint
const requestHeaders = {
  headers: {'content-type': 'application/json',
            'Authorization':'Bearer ' + apiAccessToken},
  method: 'POST'};

sendHttpRequest(requestEndpoint,(responseStatusCode, responseHeaders, responseBody) => {
  if (isLogEnabled) {
    logToConsole(JSON.stringify({
      'Name': 'Pinterest Conversions API',
      'Type': 'Response',
      'AdvertiserId': data.advertiserId,
      'EventName': event.event_name,
      'ResponseStatusCode': responseStatusCode,
      'ResponseHeaders': responseHeaders,
      'ResponseBody': responseBody
    }));
  }
  if (responseStatusCode >= 200 && responseStatusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  },
  requestHeaders,
  JSON.stringify(eventRequest)
);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.pinterest.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_pinterest_sess"
              },
              {
                "type": 1,
                "string": "_pinterest_ct"
              },
              {
                "type": 1,
                "string": "_pinterest_ct_rt"
              },
              {
                "type": 1,
                "string": "_epik"
              },
              {
                "type": 1,
                "string": "_derived_epik"
              },
              {
                "type": 1,
                "string": "_pin_unauth"
              },
              {
                "type": 1,
                "string": "_pinterest_ct_ua"
              },
              {
                "type": 1,
                "string": "_routing_id"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_sess"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_ct"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_ct_rt"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_epik"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_derived_epik"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pin_unauth"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_ct_ua"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_routing_id"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: On EventModel model data tag triggers to send to Pinterest Conversions API
  code: |-
    // Act
    runCode(testConfigurationData);

    //Assert
    assertApi('sendHttpRequest').wasCalledWith(requestEndpoint, actualSuccessCallback, requestHeaderOptions, JSON.stringify(requestData));
    assertApi('gtmOnSuccess').wasCalled();
- name: On sending action source from Client, Tag overrides the preset configuration
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.action_source = testData.action_source;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].action_source).isEqualTo(testConfigurationData.serverEventDataList[testConfigurationData.serverEventDataList.map(o => o.name).indexOf('action_source')].value);
- name: On not sending action source from Client, Tag set 'web' as a default value
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.action_source = null;
      return inputEventModel;
    });
    testConfigurationData.serverEventDataList = null;
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].action_source).isEqualTo(DEFAULT_ACTION_SOURCE);
- name: On receiving event name, trims and lowercases it to support case insensitive
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.event_name = ' Add_to_Cart ';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].event_name).isEqualTo('add_to_cart');
- name: On receiving event, hashes the the user_data fields if they are not already
    hashed
  code: |-
    // Un-hashed raw email_address from Common Event Schema is hashed before posted to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data = {};
      inputEventModel.user_data.email_address = 'foo@bar.com';
      inputEventModel.user_data.phone_number = '1234567890';
      inputEventModel.user_data.address = {};
      inputEventModel.user_data.address.first_name = 'Foo';
      inputEventModel.user_data.address.last_name = 'Bar';
      inputEventModel.user_data.address.city = 'Menlo Park';
      inputEventModel.user_data.address.region = 'ca';
      inputEventModel.user_data.address.postal_code = '12345';
      inputEventModel.user_data.address.country = 'usa';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ph).isEqualTo(hashFunction('1234567890').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.fn).isEqualTo(hashFunction('Foo').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ln).isEqualTo(hashFunction('Bar').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ct).isEqualTo(hashFunction('Menlo Park').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.st).isEqualTo(hashFunction('ca').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.zp).isEqualTo(hashFunction('12345').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.country).isEqualTo(hashFunction('usa').split());

    // Un-hashed raw email_address in mixed-case is converted to lowercase, hashed and posted to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data.email_address = 'FOO@BAR.com';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());


    // Already sha256(email_address) field from GA4 schema, is unchanged, is posted as-is to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data.email_address = hashFunction('foo@bar.com');
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());

    // Already null email field from GA4 schema, is sent as null to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data.email_address = null;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isUndefined();
- name: When address is missing it skips parsing the nested fields
  code: |
    mock('getAllEventData', () => {
      inputEventModel.user_data = {};
      inputEventModel.user_data.email_address = 'foo@bar.com';
      inputEventModel.user_data.phone_number = '1234567890';
      return inputEventModel;
    });

    runCode(testConfigurationData);

    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ph).isEqualTo(hashFunction('1234567890').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.fn).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ln).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ct).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.st).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.zp).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.country).isUndefined();
- name: When parameters are undefined skip parsing
  code: |
    mock('getAllEventData', () => {
      inputEventModel.user_data = {};
      inputEventModel.user_data.email_address = undefined;
      inputEventModel.user_data.phone_number = '1234567890';
      inputEventModel.user_data.address = {};
      inputEventModel.user_data.address.first_name = 'John';
      inputEventModel.user_data.address.last_name = undefined;
      inputEventModel.user_data.address.city = 'menlopark';
      inputEventModel.user_data.address.region = 'ca';
      inputEventModel.user_data.address.postal_code = '94025';
      inputEventModel.user_data.address.country = 'usa';
      return inputEventModel;
    });

    runCode(testConfigurationData);

    assertThat(JSON.parse(httpBody).data[0].user_data.em).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ph).isEqualTo(hashFunction('1234567890').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.fn).isEqualTo(hashFunction('John').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ln).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ct).isEqualTo(hashFunction('menlopark').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.st).isEqualTo(hashFunction('ca').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.zp).isEqualTo(hashFunction('94025').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.country).isEqualTo(hashFunction('usa').split());
setup: |-
  // Arrange
  const JSON = require('JSON');
  const Math = require('Math');
  const getTimestampMillis = require('getTimestampMillis');
  const sha256Sync = require('sha256Sync');
  const makeInteger = require('makeInteger');
  const logToConsole = require('logToConsole');
  const DEFAULT_NAMED_PARTNER = 'ss-gtm';
  const DEFAULT_ACTION_SOURCE = 'web';

  // helper methods
  function hashFunction(input) {
    return sha256Sync(input.trim().toLowerCase(), {outputEncoding: 'hex'});
  }

  const testConfigurationData = {
    advertiserId: "123",
    apiAccessToken: "token",
    eventName: "inherit",
    overrideMode: true,
    serverEventDataList:[{name: "action_source", value: "serverWebsite"}]
  };

  const testData = {
    event_name: "add_to_cart",
    action_source: "clientWebsite",
    event_time: "123456789",
    event_id: "eventId001",
    opt_out: "true",
    user_data: {
      email_address: "web@test.com",
      phone_number: "123456789",
      gender: "m",
      date_of_birth: "19910526",
      first_name: "foo",
      last_name: "bar",
      city: "menlopark",
      state: "ca",
      country: "us",
      hashed_maids: "maid_id",
      zip: "12345",
      external_id: "user123",
      ip_address: "1.2.3.4",
      user_agent: "Test_UA",
    },
    //custom_data
    currency: "USD",
    value: "123",
    content_ids: "[\"123\", \"456\"]",
    contents:  "[{\"id\": \"123\", \"item_price\": \"12.4\", \"quantity\": 2}, {\"id\": \"456\", \"item_price\": \"14.2\", \"quantity\": 3}]",
    num_items: "5",
    "order_id": "order_id",
    "search_string": "shoes",
    language: "en"
  };

  let inputEventModel = {
    "event_name": testData.event_name,
    "action_source": testData.action_source,
    "event_time": testData.event_time,
    "event_id": testData.event_id,
    "opt_out": testData.opt_out,
    "user_data": {
      "email_address": testData.user_data.email_address,
      "phone_number": testData.user_data.phone_number,
      "gender": testData.user_data.gender,
      "date_of_birth": testData.user_data.date_of_birth,
      "address": {
        "first_name": testData.user_data.first_name,
        "last_name": testData.user_data.last_name,
        "city": testData.user_data.city,
        "region": testData.user_data.state,
        "postal_code": testData.user_data.zip,
        "country": testData.user_data.country
      },
      "hashed_maids": testData.user_data.hashed_maids,
      "external_id": testData.user_data.external_id
    },
    "ip_override": testData.user_data.ip_address,
    "user_agent": testData.user_data.user_agent,
    //custom_data
    "currency": testData.currency,
    "value": testData.value,
    "content_ids": testData.content_ids,
    "contents": testData.contents,
    "num_items": testData.num_items,
    "order_id": testData.order_id,
    "search_string": testData.search_string,
    "language": testData.language
  };

  const expectedEventData = {
  "event_name": testData.event_name.trim().toLowerCase(),
  "action_source": testConfigurationData.serverEventDataList[testConfigurationData.serverEventDataList.map(o => o.name).indexOf('action_source')].value,
  "event_time": makeInteger(testData.event_time),
  "event_id": testData.event_id,
  "opt_out": JSON.parse(testData.opt_out),
  "user_data": {
    "em": hashFunction(testData.user_data.email_address).split(),
    "ph": hashFunction(testData.user_data.phone_number).split(),
    "ge": hashFunction(testData.user_data.gender).split(),
    "db": hashFunction(testData.user_data.date_of_birth).split(),
    "fn": hashFunction(testData.user_data.first_name).split(),
    "ln": hashFunction(testData.user_data.last_name).split(),
    "ct": hashFunction(testData.user_data.city).split(),
    "st": hashFunction(testData.user_data.state).split(),
    "zp": hashFunction(testData.user_data.zip).split(),
    "country": hashFunction(testData.user_data.country).split(),
    "hashed_maids": hashFunction(testData.user_data.hashed_maids).split(),
    "external_id": hashFunction(testData.user_data.external_id).split(),
    "client_ip_address": testData.user_data.ip_address,
    "client_user_agent": testData.user_data.user_agent,
  },
  "custom_data": {
    "currency": testData.currency,
    "value": testData.value,
    "content_ids": JSON.parse(testData.content_ids),
    "contents": JSON.parse(testData.contents),
    "num_items": makeInteger(testData.num_items),
    "order_id": testData.order_id,
    "search_string": testData.search_string,
    "np": DEFAULT_NAMED_PARTNER
  },
  "language": testData.language
  };

  mock('getAllEventData', () => {
    return inputEventModel;
  });

  var apiEndpoint = 'https://api.pinterest.com/v5/ad_accounts/';
  const requestEndpoint = [apiEndpoint, testConfigurationData.advertiserId, '/events'].join('');

  let requestData = {data: [expectedEventData]};
  const requestHeaderOptions = {
    headers: {'content-type': 'application/json',
              'Authorization':'Bearer ' + testConfigurationData.apiAccessToken},
    method: 'POST'};

  let actualSuccessCallback, httpBody;
  mock('sendHttpRequest', (postUrl, response, options, body) => {
    actualSuccessCallback = response;
    httpBody = body;
    actualSuccessCallback(200, {}, '');
  });


___NOTES___

Points of Contact:

Yuchen Mou <ymou@pinterest.com>
Jian Li <jianli@pinterest.com>
Mirko Rodriguez Mallma <mrodriguezmallma@pinterest.com>

Created on 6/2/2022, 4:47:28 PM
Updated on 10/06/2022, 9:40:00 PM
