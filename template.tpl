___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "ss_pntr",
  "version": 1,
  "securityGroups": [],
  "displayName": "Pinterest API for Conversions Tag",
  "categories": [
    "CONVERSIONS",
    "TAG_MANAGEMENT"
  ],
  "brand": {
    "thumbnail": "data:image/png;base64,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\u003d",
    "displayName": "Pinterest",
    "id": "brand_pinterest"
  },
  "description": "A server-side Tag to fire events to the Pinterest Conversions API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "advertiserId",
    "displayName": "Advertiser ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "args": [
          "549\\d{9}"
        ],
        "type": "REGEX"
      }
    ],
    "help": "Pinterest Advertiser ID. You can find it by logging to the Pinterest account that owns your advertiser account, then go to \"ads.pinterest.com\". In the top navigation section, click on \"Viewing: \" and the advertiser id will be the number underneath the ad account name in the drop down menu. Advertiser Id usually starts with 549..."
  },
  {
    "type": "TEXT",
    "name": "apiAccessToken",
    "displayName": "API Access Token",
    "simpleValueType": true,
    "help": "To use the Pinterest Conversions API, you need an access token.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "eventName",
    "radioItems": [
      {
        "value": "inherit",
        "subParams": [],
        "displayValue": "Inherit from client"
      },
      {
        "value": "pinterestEventName",
        "displayValue": "Override client",
        "subParams": [
          {
            "type": "SELECT",
            "name": "eventNameStandard",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "add_payment_info",
                "displayValue": "add_payment_info"
              },
              {
                "value": "add_to_cart",
                "displayValue": "add_to_cart"
              },
              {
                "value": "add_to_wishlist",
                "displayValue": "add_to_wishlist"
              },
              {
                "value": "checkout",
                "displayValue": "checkout"
              },
              {
                "value": "custom",
                "displayValue": "custom"
              },
              {
                "value": "initiate_checkout",
                "displayValue": "initiate_checkout"
              },
              {
                "value": "lead",
                "displayValue": "lead"
              },
              {
                "value": "page_visit",
                "displayValue": "page_visit"
              },
              {
                "value": "search",
                "displayValue": "search"
              },
              {
                "value": "signup",
                "displayValue": "signup"
              },
              {
                "value": "subscribe",
                "displayValue": "subscribe"
              },
              {
                "value": "view_category",
                "displayValue": "view_category"
              },
              {
                "value": "view_content",
                "displayValue": "view_content"
              },
              {
                "value": "watch_video",
                "displayValue": "watch_video"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "page_visit"
          }
        ]
      }
    ],
    "simpleValueType": true,
    "displayName": "Event Name",
    "defaultValue": "inherit",
    "help": "Set the event name you want to send to Pinterest Conversions API. You can either inherit it from what you defined in Web container (client) or define a new Pinterest standard event name."
  },
  {
    "type": "CHECKBOX",
    "name": "overrideMode",
    "displayName": "Event Data",
    "checkboxText": "Override client data",
    "simpleValueType": true,
    "help": "If checked, you could override or set new values for parameters received from the Web container (client)."
  },
  {
    "displayName": "Event Data",
    "name": "serverEventDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "overrideMode",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "subParams": [
      {
        "name": "serverEventDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "action_source",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "action_source",
                "displayValue": "Action Source"
              },
              {
                "value": "event_time",
                "displayValue": "Event Time"
              },
              {
                "value": "event_id",
                "displayValue": "Event ID"
              },
              {
                "value": "event_source_url",
                "displayValue": "Event Source URL"
              },
              {
                "value": "opt_out",
                "displayValue": "Opt Out"
              },
              {
                "value": "partner_name",
                "displayValue": "Partner Name"
              },
              {
                "value": "app_id",
                "displayValue": "App ID"
              },
              {
                "value": "app_name",
                "displayValue": "App name"
              },
              {
                "value": "app_version",
                "displayValue": "App version"
              },
              {
                "value": "device_brand",
                "displayValue": "Device brand"
              },
              {
                "value": "device_carrier",
                "displayValue": "Device carrier"
              },
              {
                "value": "device_model",
                "displayValue": "Device model"
              },
              {
                "value": "device_type",
                "displayValue": "Device type"
              },
              {
                "value": "os_version",
                "displayValue": "OS version"
              },
              {
                "value": "wifi",
                "displayValue": "WiFi"
              },
              {
                "value": "language",
                "displayValue": "Language"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "displayName": "User Data",
    "name": "userDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "overrideMode",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "subParams": [
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "em",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "em",
                "displayValue": "Email"
              },
              {
                "value": "ph",
                "displayValue": "Phone"
              },
              {
                "value": "ge",
                "displayValue": "Gender"
              },
              {
                "value": "db",
                "displayValue": "Date of Birth"
              },
              {
                "value": "ln",
                "displayValue": "Last Name"
              },
              {
                "value": "fn",
                "displayValue": "First Name"
              },
              {
                "value": "ct",
                "displayValue": "City"
              },
              {
                "value": "st",
                "displayValue": "State"
              },
              {
                "value": "zp",
                "displayValue": "Zip"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "hashed_maids",
                "displayValue": "Maids"
              },
              {
                "value": "client_ip_address",
                "displayValue": "Client IP address"
              },
              {
                "value": "client_user_agent",
                "displayValue": "Client user agent"
              },
              {
                "value": "external_id",
                "displayValue": "External Id"
              },
              {
                "value": "click_id",
                "displayValue": "Click Id"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "displayName": "Custom Data",
    "name": "customDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "enablingConditions": [
      {
        "paramName": "overrideMode",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "subParams": [
      {
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "currency",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "currency",
                "displayValue": "Currency"
              },
              {
                "value": "value",
                "displayValue": "Value"
              },
              {
                "value": "content_name",
                "displayValue": "Content Name"
              },
              {
                "value": "content_category",
                "displayValue": "Content Category"
              },
              {
                "value": "content_brand",
                "displayValue": "Content Brand"
              },
              {
                "value": "content_ids",
                "displayValue": "Content IDs"
              },
              {
                "value": "contents",
                "displayValue": "Contents"
              },
              {
                "value": "num_items",
                "displayValue": "Number of Items"
              },
              {
                "value": "order_id",
                "displayValue": "Order ID"
              },
              {
                "value": "search_string",
                "displayValue": "Search string"
              },
              {
                "value": "opt_out_type",
                "displayValue": "OptOutType"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "testMode",
    "displayName": "Test Mode",
    "checkboxText": "Send as a test-request",
    "simpleValueType": true,
    "help": "If checked, the event will not be recorded but the API will still return the same response messages. Use this mode to verify your requests are working and your events are constructed correctly."
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logMode",
        "radioItems": [
          {
            "value": "log",
            "displayValue": "Log to console"
          },
          {
            "value": "donotlog",
            "displayValue": "Do not log"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "donotlog"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Sandbox Javascript imports
const getAllEventData = require('getAllEventData');
const getType = require('getType');
const sendHttpRequest = require('sendHttpRequest');
const JSON = require('JSON');
const Math = require('Math');
const getTimestampMillis = require('getTimestampMillis');
const sha256Sync = require('sha256Sync');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const parseUrl = require('parseUrl');
const makeInteger = require('makeInteger');
const makeString = require('makeString');
const logToConsole = require('logToConsole');


// CONSTANTS
const isLogEnabled = isLoggingEnabled();
const eventModel = getAllEventData();
if (isLogEnabled) logToConsole(JSON.stringify({'Tag Data': data}));
if (isLogEnabled) logToConsole(JSON.stringify({'Event Data': eventModel}));

// GA4 event names/types: https://support.google.com/analytics/answer/9267735
// Pinterest event names/types: https://developers.pinterest.com/docs/api/v5/#operation/events/create
const EVENT_NAME_MAPPINGS = {
  "add_to_cart": "add_to_cart",
  "addtocart": "add_to_cart",
  "purchase": "checkout",
  "buy": "checkout",
  "pay": "checkout",
  "payment": "checkout",
  "generate_lead": "lead",
  "submit_application": "lead",
  "contact": "lead",
  "page_view": "page_visit",
  "pageview": "page_visit",
  "pagevisit": "page_visit",
  "gtm.dom": "page_visit",
  "search": "search",
  "find_location": "search",
  "sign_up": "signup",
  "signup": "signup",
  "completeregistration": "signup",
  "viewcategory": "view_category",
  "viewcontent": "view_content",
  "view_item_list": "view_category",
  "watchvideo": "watch_video",
  "add_payment_info": "add_payment_info",
  "add_shipping_info": "initiate_checkout",
  "add_to_wishlist": "add_to_wishlist",
  "begin_checkout": "initiate_checkout",
  "refund": "custom",
  "remove_from_cart": "custom",
  "select_item": "view_content",
  "select_promotion": "view_content",
  "view_cart": "custom",
  "view_item": "view_content",
  "view_promotion": "view_content"
};

const PARAM_VALUE_FORMAT = {
  "event_time": "integer",
  "event_id": "string",
  "num_items": "integer",
  "opt_out": "boolean",
  "wifi": "boolean",
  "value": "string",
  "em": "array-hashed",
  "ph": "array-hashed",
  "ge": "array-hashed",
  "db": "array-hashed",
  "fn": "array-hashed",
  "ln": "array-hashed",
  "ct": "array-hashed",
  "st": "array-hashed",
  "zp": "array-hashed",
  "country": "array-hashed",
  "hashed_maids": "array-hashed",
  "external_id": "array-hashed",
  "content_ids": "array",
  "contents": "json"
};

const DEFAULT_NAMED_PARTNER = 'ss-gtm';

const DEFAULT_ACTION_SOURCE = 'web';

const DEFAULT_EVENT_TIME = Math.round(getTimestampMillis() / 1000);

const DEFAULT_CLIENT_IP_ADDRESS = eventModel.ip_override;

const DEFAULT_CLIENT_USER_AGENT = eventModel.user_agent;

// FUNCTIONS
function isAlreadyHashed(input) {
  return input && (input.match('^[A-Fa-f0-9]{64}$') != null);
}

function hashFunction(input) {
  const type = getType(input);

  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  if (input == null || isAlreadyHashed(input)) {
    return input;
  }

  return sha256Sync(input.trim().toLowerCase(), {outputEncoding: 'hex'});
}

function getContentsFromItems(items) {
    return items.map(item => {
        return {
            "id": makeString((item.item_id) ? item.item_id : item.item_name),
            "item_price": makeString(item.price),
            "quantity": makeInteger(item.quantity),
        };
    });
}

function getContentIdsFromItems(items) {
    return JSON.stringify(items.map(item => {
        return makeString((item.item_id) ? item.item_id : item.item_name);
    }));
}

function getPinterestEventName(gtmEventName, toLowerCase) {
  let pinterestEventName;
  if (data.eventName === 'inherit') {
    if (toLowerCase) {
      gtmEventName = gtmEventName.trim().toLowerCase();
    }
    pinterestEventName = EVENT_NAME_MAPPINGS[gtmEventName] || gtmEventName;
  } else if (data.eventName === 'pinterestEventName') {
    pinterestEventName = data.eventNameStandard;
  }
  return pinterestEventName;
}

function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

function convertToArrayOfStrings(input, hashIfNeeded) {
  if (input == null) {
    return input;
  }

  const type = getType(input);
  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  let arrayOfStrings = [];
  if (type == 'array') {
    arrayOfStrings = input.map((i) => makeString(i));
  }
  if (type == 'string') {
    let arrayOfObjs = replaceAll(input.toString().replace('[','').replace(']',''),'\"','').split(',');
    arrayOfStrings = arrayOfObjs.map((i) => makeString(i).trim()).filter(function(e) {
      return !(!e || e.length === 0 );
    });
  }

  return arrayOfStrings.map(item => {
    if (hashIfNeeded === true) {
      return hashFunction(item);
    }
    return item;
  });
}

function getBooleanFromString(input) {
  const type = getType(input);
  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  if (input == null) {
    return input;
  }

  return (typeof input === 'string' && (input.toLowerCase() === "true" || input.toLowerCase() === "false")) ? JSON.parse(input.toLowerCase()) : input;
}

function getJsonFromString(input) {
  const type = getType(input);
  if (type == 'undefined' || input == 'undefined') {
    return undefined;
  }

  if (input == null) {
    return input;
  }

  return (typeof input === 'string' && input.charAt(0) === '[' && input.charAt(input.length - 1) === ']' 
          && input.charAt(1) === '{' && input.charAt(input.length - 2) === '}') ? JSON.parse(input) : input;
}

function overrideEventData(event, data) {
  if (data.serverEventDataList) {
    data.serverEventDataList.forEach(d => {
      event[d.name] = d.value;
    });
  }
  if (data.userDataList) {
    data.userDataList.forEach(d => {
      event.user_data[d.name] = d.value;
    });
  }
  if (data.customDataList) {
    data.customDataList.forEach(d => {
      event.custom_data[d.name] = d.value;
    });
  }
}

function formatDataTypes(object) {
  for (let key in object) {
    if (object.hasOwnProperty(key)) {
        if (PARAM_VALUE_FORMAT[key] === 'string') object[key] = makeString(object[key]);
        if (PARAM_VALUE_FORMAT[key] === 'integer') object[key] = makeInteger(JSON.parse(object[key]));
        if (PARAM_VALUE_FORMAT[key] === 'boolean') object[key] = getBooleanFromString(object[key]);
        if (PARAM_VALUE_FORMAT[key] === 'array') object[key] = convertToArrayOfStrings(object[key], false);
        if (PARAM_VALUE_FORMAT[key] === 'array-hashed') object[key] = convertToArrayOfStrings(object[key], true);
        if (PARAM_VALUE_FORMAT[key] === 'json') object[key] = getJsonFromString(object[key]);
    }
  }
}

function isLoggingEnabled() {
  return (data.logMode === 'log') ? true : false;
}

// EVENT PARAMETERS
const event = {};
// event_name
event.event_name = getPinterestEventName(eventModel.event_name, true);
// action_source
event.action_source = eventModel.action_source ? eventModel.action_source : DEFAULT_ACTION_SOURCE;
// event_time
event.event_time = eventModel.event_time ? eventModel.event_time : DEFAULT_EVENT_TIME;
// event_id
if (eventModel.event_id) {
  event.event_id = eventModel.event_id;
}
// event_source_url
event.event_source_url = eventModel.event_source_url ? eventModel.event_source_url : eventModel.page_location;
// opt_out
if (eventModel.opt_out) {
  event.opt_out = eventModel.opt_out;
}
// partner_name
if (eventModel.partner_name) {
  event.partner_name = eventModel.partner_name;
}

// AUTHORIZATION PARAMETERS
const apiAccessToken = data.apiAccessToken;

// USER PARAMETERS (user_data)
event.user_data = {};
if (eventModel.user_data != null) {
  // em
  if (eventModel.user_data.email_address) {
    event.user_data.em = eventModel.user_data.email_address;
  }
  // ph
  if (eventModel.user_data.phone_number) {
    event.user_data.ph = eventModel.user_data.phone_number;
  }
  // ge
  if (eventModel.user_data.gender) {
    event.user_data.ge = eventModel.user_data.gender;
  }
  // db
  if (eventModel.user_data.date_of_birth) {
    event.user_data.db = eventModel.user_data.date_of_birth;
  }

  if (eventModel.user_data.address != null) {
    const addressData = eventModel.user_data.address;
    // fn
    event.user_data.fn = addressData.first_name;
    // ln
    event.user_data.ln = addressData.last_name;
    // ct
    event.user_data.ct = addressData.city;
    // st
    event.user_data.st = addressData.region;
    // zp
    event.user_data.zp = addressData.postal_code;
    // country
    event.user_data.country = addressData.country;
  }
  // hashed_maids
  if (eventModel.user_data.hashed_maids) {
    event.user_data.hashed_maids = eventModel.user_data.hashed_maids;
  }
  // external_id
  if (eventModel.user_data.external_id) {
    event.user_data.external_id = eventModel.user_data.external_id;
  }
  // click_id
  if (eventModel.user_data.click_id) {
    event.user_data.click_id = eventModel.user_data.click_id;
  }
}

// client_ip_address / default
event.user_data.client_ip_address = (eventModel.user_data && eventModel.user_data.client_ip_address) ? eventModel.user_data.client_ip_address : DEFAULT_CLIENT_IP_ADDRESS;
// client_user_agent / default
event.user_data.client_user_agent = (eventModel.user_data && eventModel.user_data.client_user_agent) ? eventModel.user_data.client_user_agent : DEFAULT_CLIENT_USER_AGENT;

// CUSTOM PARAMETERS (custom_data)
event.custom_data = {};
// currency
if (eventModel.currency) {
  event.custom_data.currency = eventModel.currency;
}
// value
if (eventModel.value) {
  event.custom_data.value = eventModel.value;
}
// content_name
if (eventModel.content_name) {
  event.custom_data.content_name = eventModel.content_name;
}
// content_category
if (eventModel.content_category) {
  event.custom_data.content_category = eventModel.content_category;
}
// content_brand
if (eventModel.content_brand) {
  event.custom_data.content_brand = eventModel.content_brand;
}
// content_ids
if (eventModel.content_ids) {
  event.custom_data.content_ids = eventModel.content_ids;
} else if (eventModel.items) {
  event.custom_data.content_ids = getContentIdsFromItems(eventModel.items);
}
// contents
if (eventModel.contents) {
  event.custom_data.contents = eventModel.contents;
} else if (eventModel.items) {
  event.custom_data.contents = getContentsFromItems(eventModel.items);
}
// num_items
if (eventModel.num_items) {
  event.custom_data.num_items = eventModel.num_items;
} else if (eventModel.items) {
  event.custom_data.num_items = eventModel.items.length;
}
// order_id
if (eventModel.order_id) {
  event.custom_data.order_id = eventModel.order_id;
}
// search_string
if (eventModel.search_string) {
  event.custom_data.search_string = eventModel.search_string;
}
// opt_out_type
if (eventModel.opt_out_type) {
  event.custom_data.opt_out_type = eventModel.opt_out_type;
}
// app_id
if (eventModel.app_id) {
  event.app_id = eventModel.app_id;
}
// app_name
if (eventModel.app_name) {
  event.app_name = eventModel.app_name;
}
// app_version
if (eventModel.app_version) {
  event.app_version = eventModel.app_version;
}
// device_brand
if (eventModel.device_brand) {
  event.device_brand = eventModel.device_brand;
}
// device_carrier
if (eventModel.device_carrier) {
  event.device_carrier = eventModel.device_carrier;
}
// device_model
if (eventModel.device_model) {
  event.device_model = eventModel.device_model;
}
// device_type
if (eventModel.device_type) {
  event.device_type = eventModel.device_type;
}
// os_version
if (eventModel.os_version) {
  event.os_version = eventModel.os_version;
}
// wifi
if (eventModel.wifi) {
  event.wifi = eventModel.wifi;
}
// language
if (eventModel.language) {
  event.language = eventModel.language.slice(0,2);
}

// np
event.custom_data.np = DEFAULT_NAMED_PARTNER;

// OVERRIDE EVENT DATA
if (data.overrideMode) {
  overrideEventData(event, data);
}

// ENSURE CORRECT FORMAT
formatDataTypes(event);
if (event.user_data) formatDataTypes(event.user_data);
if (event.custom_data) formatDataTypes(event.custom_data);

// PINTEREST API ENDPOINT
const API_ENDPOINT = 'https://api.pinterest.com/v5/ad_accounts/';
var requestEndpoint = [API_ENDPOINT, data.advertiserId, '/events'].join('');
if (data.testMode) {
  requestEndpoint = [requestEndpoint,'?test=true'].join('');
}
const eventRequest = {data: [event]};
if (isLogEnabled) {
  logToConsole(JSON.stringify({
    'Name': 'Pinterest Conversions API',
    'Type': 'Request',
    'RequestMethod': 'POST',
    'RequestUrl': requestEndpoint,
    'AdvertiserId': data.advertiserId,
    'EventName': event.event_name,
    'RequestBody (payload)': eventRequest
  }));
}

// Posting to Pinterest Conversions API endpoint
const requestHeaders = {
  headers: {'content-type': 'application/json',
            'Authorization':'Bearer ' + apiAccessToken},
  method: 'POST'};

sendHttpRequest(requestEndpoint,(responseStatusCode, responseHeaders, responseBody) => {
  if (isLogEnabled) {
    logToConsole(JSON.stringify({
      'Name': 'Pinterest Conversions API',
      'Type': 'Response',
      'AdvertiserId': data.advertiserId,
      'EventName': event.event_name,
      'ResponseStatusCode': responseStatusCode,
      'ResponseHeaders': responseHeaders,
      'ResponseBody': responseBody
    }));
  }
  if (responseStatusCode >= 200 && responseStatusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  },
  requestHeaders,
  JSON.stringify(eventRequest)
);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.pinterest.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_pinterest_sess"
              },
              {
                "type": 1,
                "string": "_pinterest_ct"
              },
              {
                "type": 1,
                "string": "_pinterest_ct_rt"
              },
              {
                "type": 1,
                "string": "_epik"
              },
              {
                "type": 1,
                "string": "_derived_epik"
              },
              {
                "type": 1,
                "string": "_pin_unauth"
              },
              {
                "type": 1,
                "string": "_pinterest_ct_ua"
              },
              {
                "type": 1,
                "string": "_routing_id"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_sess"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_ct"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_ct_rt"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_epik"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_derived_epik"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pin_unauth"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_pinterest_ct_ua"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_routing_id"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: On EventModel model data tag triggers to send to Pinterest Conversions API (cAPI)
  code: |-
    // Act
    runCode(testConfigurationData);

    //Assert
    assertApi('sendHttpRequest').wasCalledWith(requestEndpoint, actualSuccessCallback, requestHeaderOptions, JSON.stringify(requestData));
    assertApi('gtmOnSuccess').wasCalled();
- name: On sending 'action_source' from Client, Tag overrides the preset configuration from server side
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.action_source = testData.action_source;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].action_source).isEqualTo(testConfigurationData.serverEventDataList[testConfigurationData.serverEventDataList.map(o => o.name).indexOf('action_source')].value);
- name: On not sending 'action_source' from Client, Tag set 'web' as a default value for cAPI
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.action_source = null;
      return inputEventModel;
    });
    testConfigurationData.serverEventDataList = null;
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].action_source).isEqualTo(DEFAULT_ACTION_SOURCE);
- name: On receiving 'event_name', Tag trims and lowercases it to support case insensitive
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.event_name = ' Add_to_Cart ';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].event_name).isEqualTo('add_to_cart');
- name: On receiving 'event_name', Tag tries to map it to a standard event name
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.event_name = 'purchase';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].event_name).isEqualTo('checkout');

    // Act
    mock('getAllEventData', () => {
      inputEventModel.event_name = ' PAGE_VIEW';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].event_name).isEqualTo('page_visit');

    // Act
    mock('getAllEventData', () => {
      inputEventModel.event_name = 'view_cart';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].event_name).isEqualTo('custom');

    // Act
    mock('getAllEventData', () => {
      inputEventModel.event_name = ' ANY_other_Name ';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].event_name).isEqualTo('any_other_name');
- name: On receiving event data, Tag hashes the 'user_data' fields if they are not already hashed
  code: |-
    // Un-hashed raw email_address from Common Event Schema is hashed before posted to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data = {};
      inputEventModel.user_data.email_address = '[foo1@bar.com,foo2@bar.com]';
      inputEventModel.user_data.phone_number = 'c775e7b757ede630cd0aa1113bd102661ab38829ca52a6422ab782862f268646';
      inputEventModel.user_data.gender = " m ";
      inputEventModel.user_data.hashed_maids = ["maid_01", "6ab15588d5535128752e63d57e2e216234e9633c6397cdcc98f4976b53d2a381"];
      inputEventModel.user_data.address = {};
      inputEventModel.user_data.address.first_name = 'Foo';
      inputEventModel.user_data.address.last_name = "[Bar]";
      inputEventModel.user_data.address.city = 'Menlo Park';
      inputEventModel.user_data.address.region = 'ca';
      inputEventModel.user_data.address.postal_code = '5994471abb01112afcc18159f6cc74b4f511b99806da59b3caf5a9c173cacfc5';
      inputEventModel.user_data.address.country = ['usa'];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo([hashFunction('foo1@bar.com'),hashFunction('foo2@bar.com')]);
    assertThat(JSON.parse(httpBody).data[0].user_data.ph).isEqualTo(["c775e7b757ede630cd0aa1113bd102661ab38829ca52a6422ab782862f268646"]);
    assertThat(JSON.parse(httpBody).data[0].user_data.ge).isEqualTo(hashFunction('m').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.hashed_maids).isEqualTo([hashFunction('maid_01'),"6ab15588d5535128752e63d57e2e216234e9633c6397cdcc98f4976b53d2a381"]);
    assertThat(JSON.parse(httpBody).data[0].user_data.fn).isEqualTo(hashFunction('Foo').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ln).isEqualTo(hashFunction('Bar').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ct).isEqualTo(hashFunction('Menlo Park').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.st).isEqualTo(hashFunction('ca').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.zp).isEqualTo(["5994471abb01112afcc18159f6cc74b4f511b99806da59b3caf5a9c173cacfc5"]);
    assertThat(JSON.parse(httpBody).data[0].user_data.country).isEqualTo(hashFunction('usa').split());

    // Un-hashed raw email_address in mixed-case is converted to lowercase, hashed and posted to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data.email_address = 'FOO@BAR.com';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());


    // Already sha256(email_address) field from GA4 schema, is unchanged, is posted as-is to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data.email_address = hashFunction('foo@bar.com');
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());

    // Already null email field from GA4 schema, is sent as null to Conversions API.

    // Act
    mock('getAllEventData', () => {
      inputEventModel.user_data.email_address = null;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].user_data.em).isUndefined();
- name: When some 'user_data' params are missing, Tag skips parsing the nested fields
  code: |
    mock('getAllEventData', () => {
      inputEventModel.user_data = {};
      inputEventModel.user_data.email_address = 'foo@bar.com';
      inputEventModel.user_data.phone_number = '1234567890';
      return inputEventModel;
    });

    runCode(testConfigurationData);

    assertThat(JSON.parse(httpBody).data[0].user_data.em).isEqualTo(hashFunction('foo@bar.com').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ph).isEqualTo(hashFunction('1234567890').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.fn).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ln).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ct).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.st).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.zp).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.country).isUndefined();
- name: When some 'user_data' params are undefined, Tag skips parsing them
  code: |
    mock('getAllEventData', () => {
      inputEventModel.user_data = {};
      inputEventModel.user_data.email_address = undefined;
      inputEventModel.user_data.phone_number = '1234567890';
      inputEventModel.user_data.address = {};
      inputEventModel.user_data.address.first_name = 'John';
      inputEventModel.user_data.address.last_name = undefined;
      inputEventModel.user_data.address.city = 'menlopark';
      inputEventModel.user_data.address.region = 'ca';
      inputEventModel.user_data.address.postal_code = '94025';
      inputEventModel.user_data.address.country = 'usa';
      return inputEventModel;
    });

    runCode(testConfigurationData);

    assertThat(JSON.parse(httpBody).data[0].user_data.em).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ph).isEqualTo(hashFunction('1234567890').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.fn).isEqualTo(hashFunction('John').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.ln).isUndefined();
    assertThat(JSON.parse(httpBody).data[0].user_data.ct).isEqualTo(hashFunction('menlopark').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.st).isEqualTo(hashFunction('ca').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.zp).isEqualTo(hashFunction('94025').split());
    assertThat(JSON.parse(httpBody).data[0].user_data.country).isEqualTo(hashFunction('usa').split());
- name: On receiving 'value' as number, Tag converts it to String format
  code: |
    // Act
    mock('getAllEventData', () => {
      inputEventModel.value = 12.45;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.value).isEqualTo("12.45");

    // Act
    mock('getAllEventData', () => {
      inputEventModel.value = '12.45';
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.value).isEqualTo("12.45");

    // Act
    mock('getAllEventData', () => {
      inputEventModel.value = 12;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.value).isEqualTo("12");
- name: On receiving 'content_ids' with different formats, Tag transforms it to an Array of Strings
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = ["id_1","id_2"];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo(["id_1","id_2"]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = [1, 2, 3];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo(["1","2","3"]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = ["1", 2.5, "3.10"];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo(["1","2.5","3.10"]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = "[1 , 2.5, 3]";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo(["1","2.5","3"]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = "[\"1\" , 2.5, \"3\"]";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo(["1","2.5","3"]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = "[1 , , 3]";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo(["1","3"]);
    
    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = "  ";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isEqualTo([]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = "";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isUndefined();


    // Act
    mock('getAllEventData', () => {
      inputEventModel.content_ids = null;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.content_ids).isUndefined();
- name: On receiving 'contents' with different formats, Tag transforms it to a valid Json object if feasible
  code: |-
    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = [{"id":"value"}];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"value"}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = ["id_1","id_2"];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo(["id_1","id_2"]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = "[\"id_1\",\"id_2\"]";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo("[\"id_1\",\"id_2\"]");

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = "[{\"id_1\":\"value_1\"},{\"id_2\":\"value_2\"}]";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id_1":"value_1"},{"id_2":"value_2"}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = [{"id":"id01","item_price":"12.4","quantity":12}];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"id01","item_price":"12.4","quantity":12}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = "[{\"id\":\"id01\",\"item_price\":\"12.4\",\"quantity\":12}]";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"id01","item_price":"12.4","quantity":12}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = "";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isUndefined();

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = null;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isUndefined();

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = " ";
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo(" ");
- name: On receiving 'items' from GA4 event, Tag parses them into 'contents' for cAPI
  code: |
    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = null;
      inputEventModel.items = [{item_id: 10, price: 12.4, quantity: 2}];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"10","item_price":"12.4","quantity":2}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = undefined;
      inputEventModel.items = [{item_id: "id-01", "price": "12.4", quantity: 2}];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"id-01","item_price":"12.4","quantity":2}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = undefined;
      inputEventModel.items = [{item_name: "shoes", price: 0, "quantity": "2"}];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"shoes","item_price":"0","quantity":2}]);

    // Act
    mock('getAllEventData', () => {
      inputEventModel.contents = undefined;
      inputEventModel.items = [{item_id: 5, item_name: "shoes", price: 0, "quantity": "2"},{item_name: "item_01", price: 12.5, "quantity": "3"}];
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents).isEqualTo([{"id":"5","item_price":"0","quantity":2},{"id":"item_01","item_price":"12.5","quantity":3}]);
- name: On receiving 'items' from GA4 event, Tag parses them into 'content_ids', 'contents' and 'num_items' for cAPI
  code: |
    // Act
    let items = [
      {
        item_id: '1',
        item_name: 'item_1',
        quantity: 5,
        price: 123.45,
        item_category: 'cat_1',
        item_brand: 'brand_1',
      },
      {
        item_id: '2',
        item_name: 'item_2',
        quantity: 10,
        price: 123.45,
        item_category: 'cat_2',
        item_brand: 'brand_2',
      }
    ];
    mock('getAllEventData', () => {
      inputEventModel.contents = null;
      inputEventModel.content_ids = null;
      inputEventModel.num_items = null;
      inputEventModel.items = items;
      return inputEventModel;
    });
    runCode(testConfigurationData);

    //Assert
    let actual_contents = JSON.parse(httpBody).data[0].custom_data.contents;
    let actual_content_ids = JSON.parse(httpBody).data[0].custom_data.content_ids;
    for( var i = 0; i < items.length; i++) {
      // contents
      assertThat(actual_contents[i].id).isEqualTo(makeString(items[i].item_id));
      assertThat(actual_contents[i].item_price).isEqualTo(makeString(items[i].price));
      assertThat(actual_contents[i].quantity).isEqualTo(makeInteger(items[i].quantity));
      // content_ids
      assertThat(actual_content_ids[i]).isEqualTo(makeString((items[i].item_id) ? items[i].item_id : items[i].item_name));
    }
    // num_items
    let actual_num_items = JSON.parse(httpBody).data[0].custom_data.num_items;
    assertThat(JSON.parse(httpBody).data[0].custom_data.contents.length).isEqualTo(items.length);
setup: |-
  // Arrange
  const JSON = require('JSON');
  const Math = require('Math');
  const getTimestampMillis = require('getTimestampMillis');
  const sha256Sync = require('sha256Sync');
  const makeInteger = require('makeInteger');
  const makeString = require('makeString');
  const logToConsole = require('logToConsole');
  const DEFAULT_NAMED_PARTNER = 'ss-gtm';
  const DEFAULT_ACTION_SOURCE = 'web';

  // helper methods
  function hashFunction(input) {
    return sha256Sync(input.trim().toLowerCase(), {outputEncoding: 'hex'});
  }

  const testConfigurationData = {
    advertiserId: "123",
    apiAccessToken: "token",
    eventName: "inherit",
    overrideMode: true,
    serverEventDataList:[{name: "action_source", value: "serverWebsite"}]
  };

  const testData = {
    event_name: "add_to_cart",
    action_source: "web",
    event_time: "1679414563",
    event_id: "eventId001",
    opt_out: "true",
    user_data: {
      email_address: "web@test.com",
      phone_number: "123456789",
      gender: "m",
      date_of_birth: "19910526",
      first_name: "mirko",
      last_name: "rodriguez",
      city: "menlopark",
      state: "ca",
      country: "us",
      hashed_maids: "EA7583CD-A667-48BC-B806-42ECB2B48606",
      zip: "12345",
      external_id: "cdda802e-fb9c-47ad-9866-0794d394c912",
      ip_address: "216.3.128.12",
      user_agent: "Test_UA",
      click_id: "dj0yJnU9b2JDcFFHekV4SHJNcmVrbFBkUEdqakh0akdUT1VjVVUmcD0yJm49cnNBQ3F2Q2dOVDBXWWhkWklrUGxBUSZ0PUFBQUFBR1BaY3Bv"
    },
    //custom_data
    currency: "USD",
    value: "123",
    content_name: "pinterest-themed-clothing",
    content_category: "shirts",
    content_brand: "pinterest-brand",
    content_ids: ["id_01", "id_02"],
    contents:  [{"id": "id_01", "item_price": "12.4", "quantity": 2}, {"id": "id_02", "item_price": "14.2", "quantity": 3}],
    num_items: "5",
    order_id: "order_id",
    search_string: "shoes",
    opt_out_type: "LDP",
    language: "en"
  };

  let inputEventModel = {
    "event_name": testData.event_name,
    "action_source": testData.action_source,
    "event_time": testData.event_time,
    "event_id": testData.event_id,
    "opt_out": testData.opt_out,
    "user_data": {
      "email_address": testData.user_data.email_address,
      "phone_number": testData.user_data.phone_number,
      "gender": testData.user_data.gender,
      "date_of_birth": testData.user_data.date_of_birth,
      "address": {
        "first_name": testData.user_data.first_name,
        "last_name": testData.user_data.last_name,
        "city": testData.user_data.city,
        "region": testData.user_data.state,
        "postal_code": testData.user_data.zip,
        "country": testData.user_data.country
      },
      "hashed_maids": testData.user_data.hashed_maids,
      "external_id": testData.user_data.external_id,
      "click_id": testData.user_data.click_id
    },
    "ip_override": testData.user_data.ip_address,
    "user_agent": testData.user_data.user_agent,
    //custom_data
    "currency": testData.currency,
    "value": testData.value,
    "content_name": testData.content_name,
    "content_category": testData.content_category,
    "content_brand": testData.content_brand,
    "content_ids": testData.content_ids,
    "contents": testData.contents,
    "num_items": testData.num_items,
    "order_id": testData.order_id,
    "search_string": testData.search_string,
    "opt_out_type": testData.opt_out_type,
    "language": testData.language
  };

  const expectedEventData = {
  "event_name": testData.event_name.trim().toLowerCase(),
  "action_source": testConfigurationData.serverEventDataList[testConfigurationData.serverEventDataList.map(o => o.name).indexOf('action_source')].value,
  "event_time": makeInteger(testData.event_time),
  "event_id": testData.event_id,
  "opt_out": JSON.parse(testData.opt_out),
  "user_data": {
    "em": hashFunction(testData.user_data.email_address).split(),
    "ph": hashFunction(testData.user_data.phone_number).split(),
    "ge": hashFunction(testData.user_data.gender).split(),
    "db": hashFunction(testData.user_data.date_of_birth).split(),
    "fn": hashFunction(testData.user_data.first_name).split(),
    "ln": hashFunction(testData.user_data.last_name).split(),
    "ct": hashFunction(testData.user_data.city).split(),
    "st": hashFunction(testData.user_data.state).split(),
    "zp": hashFunction(testData.user_data.zip).split(),
    "country": hashFunction(testData.user_data.country).split(),
    "hashed_maids": hashFunction(testData.user_data.hashed_maids).split(),
    "external_id": hashFunction(testData.user_data.external_id).split(),
    "click_id": testData.user_data.click_id,
    "client_ip_address": testData.user_data.ip_address,
    "client_user_agent": testData.user_data.user_agent,
  },
  "custom_data": {
    "currency": testData.currency,
    "value": testData.value,
    "content_name": testData.content_name,
    "content_category": testData.content_category,
    "content_brand": testData.content_brand,
    "content_ids": testData.content_ids,
    "contents": testData.contents,
    "num_items": makeInteger(testData.num_items),
    "order_id": testData.order_id,
    "search_string": testData.search_string,
    "opt_out_type": testData.opt_out_type,
    "np": DEFAULT_NAMED_PARTNER
  },
  "language": testData.language
  };

  mock('getAllEventData', () => {
    return inputEventModel;
  });

  var apiEndpoint = 'https://api.pinterest.com/v5/ad_accounts/';
  const requestEndpoint = [apiEndpoint, testConfigurationData.advertiserId, '/events'].join('');

  let requestData = {data: [expectedEventData]};
  const requestHeaderOptions = {
    headers: {'content-type': 'application/json',
              'Authorization':'Bearer ' + testConfigurationData.apiAccessToken},
    method: 'POST'};

  let actualSuccessCallback, httpBody;
  mock('sendHttpRequest', (postUrl, response, options, body) => {
    actualSuccessCallback = response;
    httpBody = body;
    actualSuccessCallback(200, {}, '');
  });


___NOTES___

Points of Contact:

Yuchen Mou <ymou@pinterest.com>
Jian Li <jianli@pinterest.com>
Mirko J. Rodriguez Mallma <mrodriguezmallma@pinterest.com>

Created on 6/2/2022, 4:47:28 PM
Updated on 7/17/2025, 12:00:00 PM
